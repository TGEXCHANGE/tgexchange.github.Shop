<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TG GROUP - Exchange (Final)</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

<!-- üî• 1. FIREBASE SDKs üî• -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: "#007BFF",
        success: "#28a745",
        danger: "#dc3545",
        'background-light': "#F7F9FC",
        'tg-green': "#34a853", 
      },
      fontFamily: { display: ["Inter","sans-serif"] },
      borderRadius: { DEFAULT: "0.5rem" }
    }
  }
}
</script>
<style>
/* Base Styles */
:root{--sidebar-w:280px;--sidebar-collapsed-w:64px;}
.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz'24;}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; background:#F7F9FC; color:#0f172a;}
.app { display:flex; min-height:100vh; }
aside{ width:var(--sidebar-w); min-width:var(--sidebar-w); background:white; border-right:1px solid #e6eef8; display:flex; flex-direction:column; transition: all .22s ease; z-index:1000; }
aside.collapsed{ width:var(--sidebar-collapsed-w); min-width:var(--sidebar-collapsed-w); }
.brand{ display:flex; align-items:center; gap:12px; padding:16px; }
.brand .title{ font-weight:700; font-size:1rem; }
.collapsed .brand .title { display:none; }
nav{ padding:8px 10px; flex:1; overflow:auto; }
.nav-item{ display:flex; align-items:center; gap:12px; padding:10px; border-radius:8px; color:#334155; margin:6px 4px; cursor:pointer; }
.nav-item:hover{ background:#f1f5f9; }
.nav-item .icon{ width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:#f8fafc; }
.collapsed .nav-item .label { display:none; }
.nav-item .tooltip{ display:none; position:absolute; left:calc(var(--sidebar-collapsed-w) + 12px); transform:translateX(8px); background:#0b1220; color:white; padding:6px 10px; border-radius:6px; box-shadow:0 6px 20px rgba(2,6,23,0.2); white-space:nowrap; z-index:1200; font-size:0.9rem; }
.sidebar-footer{ padding:12px; border-top:1px solid #eef2f7; background:transparent; }
.collapsed .sidebar-footer .support-text { display:none; }
.main { flex:1; display:flex; flex-direction:column; min-height:100vh; }
.header{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #eef2f7; background:white; z-index:800; }
.header .left { display:flex; align-items:center; gap:12px; }
.hamburger{ display:none; padding:8px; border-radius:8px; }
.content{ padding:18px; flex:1; overflow:auto; padding-bottom:80px; } 
.grid{ display:grid; grid-template-columns:1fr; gap:18px; }
@media(min-width:1024px){ .grid{ grid-template-columns: 2fr 1fr; } }
.card{ background:white; border:1px solid #eef2f7; border-radius:10px; padding:16px; }
.overlay{ position:fixed; inset:0; background:rgba(2,6,23,0.45); display:none; z-index:900; }
.overlay.show{ display:block; }
@media(max-width:768px){
  aside{ position:fixed; left:-320px; top:0; height:100vh; box-shadow:8px 18px 60px rgba(2,6,23,0.2); }
  aside.open{ left:0; }
  .hamburger{ display:inline-flex; }
  .brand .title{ display:inline-block; }
  .collapsed{ width:var(--sidebar-w); min-width:var(--sidebar-w); } 
  .overlay{ display:none; }
  .overlay.show{ display:block; }
}
@media(min-width:769px) and (max-width:1024px){
  .collapsed aside .nav-item .tooltip{ display:block; opacity:0; transition:opacity .12s ease; pointer-events:none; }
  .collapsed aside .nav-item:hover .tooltip{ opacity:1; pointer-events:auto; }
}
.stat-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
@media(min-width:640px){ .stat-grid{ grid-template-columns:repeat(3,1fr); } }
.table{ width:100%; border-collapse:collapse; }
.table th, .table td{ padding:12px 8px; text-align:left; border-bottom:1px solid #f1f5f9; }
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2000; background:rgba(2,6,23,0.45); }
.modal.open{ display:flex; }
.modal .modal-card{ width:100%; max-width:720px; border-radius:12px; padding:18px; background:white; }
.btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:1px solid transparent; }
.btn-primary{ background:var(--primary,#007BFF); color:white; border-color:var(--primary,#007BFF); }
.btn-outline{ background:transparent; border-color:#e6eef8; color:#0f172a; }
.form-row { margin-bottom: 15px; }
.input-field { width:100%;padding:10px 12px;box-sizing: border-box;border-radius:8px;border:1px solid #ccc;font-size:1em;outline: none;transition: border-color 0.3s; }
.input-field:focus {border-color: #4a4aed;}
.close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; padding: 0; }
.close-btn:hover { color: #0f172a; }

/* üîê Auth-Specific Styles (For New UI) */
.custom-input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
    outline: none;
}
.custom-input:focus {
    border-color: #007BFF;
    box-shadow: 0 0 0 1px #007BFF;
}
.auth-modal-card { 
    max-width: 360px !important; 
    padding: 30px !important; 
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 10px rgba(0,0,0,0.05); 
    border: none;
}
.auth-modal-card .close-btn { 
    position: absolute; 
    top: 15px; 
    right: 15px;
}
.auth-modal-card .form-row {
    text-align: left; 
}
.auth-modal-card label { 
    display: block; 
    font-size: 0.9rem; 
    font-weight: 500; 
    margin-bottom: 4px;
}
.auth-brand {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px;
}
.auth-brand-logo {
    width: 50px;
    height: 50px;
    background: #34a853; 
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    font-size: 24px;
    font-weight: 700;
    box-shadow: 0 4px 10px rgba(52, 168, 83, 0.4);
}
.auth-brand-title {
    font-size: 12px;
    color: #34a853;
    font-weight: 600;
    margin-top: 4px;
}
.error-message {
    color: var(--danger);
    font-size: 0.9rem;
    margin-top: 10px;
    font-weight: 500;
    text-align: center;
}
/* üî• NEW: How It Works Modal Styles */
.section-img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 12px;
  margin-top: 18px;
}
.section-text {
  margin-top: 20px;
  color: #495057;
  font-size: 15px;
}
.section-text ol {
  padding-left: 18px;
  line-height: 1.7;
}
</style>
</head>
<body class="font-display bg-background-light">

<div class="app" id="appRoot" style="display:none;">
  <div id="mobileOverlay" class="overlay" onclick="closeMobile()"></div>
  <aside id="sidebar" class="" aria-label="Main navigation">
    <div class="brand">
      <div class="logo"><img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="logo" style="width:22px;height:22px;"/></div>
      <div class="title">TG Group Exchange</div>
      <button id="collapseBtn" title="Collapse sidebar" style="margin-left:auto;background:none;border:0;padding:6px;border-radius:8px;cursor:pointer;"><span class="material-symbols-outlined">chevron_left</span></button>
    </div>

    <nav id="navList">
      <div class="nav-item" data-title="Dashboard" tabindex="0">
        <div class="icon"><span class="material-symbols-outlined">dashboard</span></div>
        <div class="label">Dashboard</div>
        <div class="tooltip">Dashboard</div>
      </div>
      <div class="nav-item" data-title="Sell Group" tabindex="0" onclick="openModal('sellModal')">
        <div class="icon"><span class="material-symbols-outlined">sell</span></div>
        <div class="label">Sell Group</div>
        <div class="tooltip">Sell Group</div>
      </div>
      <div class="nav-item" data-title="Withdraw" tabindex="0" onclick="openModal('withdrawModal')">
        <div class="icon"><span class="material-symbols-outlined">account_balance_wallet</span></div>
        <div class="label">Withdraw</div>
        <div class="tooltip">Withdraw</div>
      </div>
      <div class="nav-item" data-title="Records" tabindex="0" onclick="openModal('recordsModal')">
        <div class="icon"><span class="material-symbols-outlined">receipt_long</span></div>
        <div class="label">Records</div>
        <div class="tooltip">Records</div>
      </div>
      <!-- MODIFIED: Added onclick to open new modal -->
      <div class="nav-item" data-title="How it works" tabindex="0" onclick="openModal('howItWorksModal')">
        <div class="icon"><span class="material-symbols-outlined">help_center</span></div>
        <div class="label">How it works</div>
        <div class="tooltip">How it works</div>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div style="padding:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <img src="https://i.ibb.co/BMdH2fz/Pngtree-customer-support-agent-at-work-19770230.png" alt="support" style="width:44px;height:44px;border-radius:8px;object-fit:cover;"/>
          <div style="flex:1;">
            <div style="font-weight:700;">Need Help?</div>
            <div class="support-text" style="font-size:12px;color:#64748b;">Contact support for questions</div>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="contactBtn" class="btn btn-primary" style="width:100%;">Contact Support</button>
        </div>
      </div>
    </div>
  </aside>

  <div class="main">
    <header class="header">
      <div class="left">
        <button id="mobileOpenBtn" class="hamburger" aria-label="Open menu"><span class="material-symbols-outlined">menu</span></button>
        <div>
          <div style="font-weight:700;">Dashboard</div>
          <div style="font-size:13px;color:#64748b;" id="welcomeMessage">Welcome!</div>
        </div>
      </div>
      <!-- User Info - Simplified -->
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="text-align:right;">
          <div style="font-weight:600;" id="userNameDisplay">Guest</div>
          <div style="font-size:13px;color:#ef4444;cursor:pointer;line-height:1.2;" id="authAction">Logout</div>
        </div>
      </div>
    </header>

    <main class="content">
      <div class="content-inner">
        <div class="grid">
          <div>
            <div class="card" style="display:flex;gap:12px;align-items:center;">
              <img src="https://i.ibb.co/JwS3Y3Jc/Notre-engagement-s-curit.jpg" alt="banner" style="width:64px;height:64px;border-radius:8px;object-fit:cover;">
              <div>
                <div style="font-weight:700;">Welcome to TG GROUP - Exchange</div>
                <div style="color:#64748b;font-size:13px;">Sell your old or inactive Telegram groups ‚Äî Fast, safe, trusted.</div>
              </div>
            </div>

            <div style="height:14px;"></div>

            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div style="font-weight:700;">Today's Summary</div>
              </div>
              <div class="stat-grid">
                <div class="card" style="display:flex;gap:12px;align-items:center;">
                  <div style="padding:10px;border-radius:8px;background:#ecfeef;"><span class="material-symbols-outlined">trending_up</span></div>
                  <div>
                    <div style="font-size:12px;color:#64748b;">Total Sold Groups</div>
                    <div style="font-weight:700;font-size:20px;" id="totalSold">0</div>
                  </div>
                </div>

                <div class="card" style="display:flex;gap:12px;align-items:center;">
                  <div style="padding:10px;border-radius:8px;background:#eef2ff;"><span class="material-symbols-outlined">payments</span></div>
                  <div>
                    <div style="font-size:12px;color:#64748b;">Balance (USDT)</div>
                    <div style="font-weight:700;font-size:20px;" id="balance">0.00</div>
                  </div>
                </div>

                <div class="card" style="display:flex;gap:12px;align-items:center;">
                  <div style="padding:10px;border-radius:8px;background:#fff7ed;"><span class="material-symbols-outlined">hourglass_top</span></div>
                  <div>
                    <div style="font-size:12px;color:#64748b;">Pending</div>
                    <div style="font-weight:700;font-size:20px;" id="pending">0</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="height:12px;"></div>

            <div class="card">
              <div style="font-weight:700;margin-bottom:8px;">Task List (Orders)</div>
              <div style="overflow:auto;">
                <table class="table" role="table" aria-label="Tasks">
                  <!-- MODIFIED: New table headers -->
                  <thead><tr><th>Task</th><th>Amount of Groups</th><th>Transfer Group Owner</th><th>Status</th></tr></thead>
                  <tbody id="taskBody"><tr><td colspan="4" style="padding:24px;text-align:center;color:#64748b;">Loading Orders...</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>

          <div>
            <div class="card" style="margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-weight:700;">Quick Actions</div>
                <div style="background:#ecfdf5;padding:6px 8px;border-radius:999px;color:#065f46;font-weight:600;font-size:12px;"><span class="material-symbols-outlined" style="vertical-align:middle;">verified_user</span> Secure</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;">
                <button class="btn btn-outline" onclick="openModal('sellModal')">Create Sell Order</button>
                <button class="btn btn-primary" onclick="openModal('withdrawModal')">Withdraw Funds</button>
                <button class="btn btn-outline" onclick="openModal('recordsModal')">View Records</button>
              </div>
            </div>

            <div class="card">
              <div style="font-weight:700;margin-bottom:8px;">Price List</div>
              <div style="overflow:auto;">
                <table class="table" role="table" aria-label="Prices">
                  <thead><tr><th>#</th><th>Year/Period</th><th style="text-align:right;">Price (USDT)</th></tr></thead>
                  <!-- START OF UPDATED PRICE LIST -->
                  <tbody>
                    <tr><td style="color:#64748b;">1</td><td>2024 (10~10)</td><td style="text-align:right;font-weight:700;">0.50</td></tr>
                    <tr><td style="color:#64748b;">2</td><td>2024 (08~08)</td><td style="text-align:right;font-weight:700;">0.80</td></tr>
                    <tr><td style="color:#64748b;">3</td><td>2024 (07~07)</td><td style="text-align:right;font-weight:700;">1.50</td></tr>
                    <tr><td style="color:#64748b;">4</td><td>2024 (06~06)</td><td style="text-align:right;font-weight:700;">3.20</td></tr>
                    <tr><td style="color:#64748b;">5</td><td>2024 (05~05)</td><td style="text-align:right;font-weight:700;">4.13</td></tr>
                    <tr><td style="color:#64748b;">6</td><td>2024 (04~04)</td><td style="text-align:right;font-weight:700;">5.40</td></tr>
                    <tr><td style="color:#64748b;">7</td><td>2024 (03~03)</td><td style="text-align:right;font-weight:700;">6.50</td></tr>
                    <tr><td style="color:#64748b;">8</td><td>2024 (02~02)</td><td style="text-align:right;font-weight:700;">6.50</td></tr>
                    <tr><td style="color:#64748b;">9</td><td>2024 (01~01)</td><td style="text-align:right;font-weight:700;">6.50</td></tr>
                    <tr><td style="color:#64748b;">10</td><td>2023</td><td style="text-align:right;font-weight:700;">10.24</td></tr>
                    <tr><td style="color:#64748b;">11</td><td>2022</td><td style="text-align:right;font-weight:700;">13.50</td></tr>
                    <tr><td style="color:#64748b;">12</td><td>2021</td><td style="text-align:right;font-weight:700;">13.50</td></tr>
                    <tr><td style="color:#64748b;">13</td><td>2020</td><td style="text-align:right;font-weight:700;">13.50</td></tr>
                    <tr><td style="color:#64748b;">14</td><td>2019</td><td style="text-align:right;font-weight:700;">13.70</td></tr>
                    <tr><td style="color:#64748b;">15</td><td>2018</td><td style="text-align:right;font-weight:700;">14.00</td></tr>
                    <tr><td style="color:#64748b;">16</td><td>2017</td><td style="text-align:right;font-weight:700;">14.00</td></tr>
                    <tr><td style="color:#64748b;">17</td><td>2016</td><td style="text-align:right;font-weight:700;">14.00</td></tr>
                  </tbody>
                  <!-- END OF UPDATED PRICE LIST -->
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- üîê Sign Up Modal (Updated UI) -->
<div id="signupModal" class="modal" aria-hidden="true"> 
  <div class="modal-card card auth-modal-card" style="position:relative;">
    <button aria-label="Close modal" class="close-btn" onclick="closeModal('signupModal')">√ó</button>

    <div class="auth-brand">
      <div class="auth-brand-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-8 h-8">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4h-2V8h4c1.1 0 2 .9 2 2v2c0 1.1-.9 2-2 2h-2v2z"/>
        </svg>
      </div>
      <div class="auth-brand-title">TG-exchange</div>
    </div>
    
    <h3 style="font-weight:700;font-size:1.4rem; margin-bottom: 25px;">Create Account</h3>
    
    <form id="signupForm">
      <div class="form-row">
        <label>Telegram Username</label>
        <input id="m_signupTelegram" type="text" placeholder="@yourusername" required class="custom-input">
      </div>
      <div class="form-row">
        <label>Email</label>
        <input id="m_signupEmail" type="email" placeholder="your.email@example.com" required class="custom-input">
      </div>
      <div class="form-row">
        <label>Password</label>
        <input id="m_signupPassword" type="password" placeholder="Min 6 characters" required class="custom-input">
      </div>
      <div class="form-row">
        <label>Confirm Password</label>
        <input id="m_signupConfirmPassword" type="password" placeholder="Re-enter password" required class="custom-input">
      </div>
      <div id="signupError" class="error-message"></div>
      <div style="margin-top:25px;">
        <button type="submit" class="btn btn-primary" style="width:100%;">Sign Up</button>
      </div>
    </form>
    <p style="text-align:center; font-size:0.9rem; color:#64748b; margin-top:15px;">
        Already have an account? 
        <a href="#" onclick="closeModal('signupModal'); openModal('loginModal'); return false;" style="color:#007BFF; font-weight:600;">
            Login here
        </a>
    </p>
  </div>
</div>

<!-- üîê Login Modal (Updated UI) -->
<div id="loginModal" class="modal" aria-hidden="true">
  <div class="modal-card card auth-modal-card" style="position:relative;">
    <button aria-label="Close modal" class="close-btn" onclick="closeModal('loginModal')">√ó</button>

    <div class="auth-brand">
      <div class="auth-brand-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-8 h-8">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4h-2V8h4c1.1 0 2 .9 2 2v2c0 1.1-.9 2-2 2h-2v2z"/>
        </svg>
      </div>
      <div class="auth-brand-title">TG-exchange</div>
    </div>
    
    <h3 style="font-weight:700;font-size:1.4rem; margin-bottom: 25px;">Login to Account</h3>
    
    <form id="loginForm">
      <div class="form-row">
        <label>Email</label>
        <input id="m_loginEmail" type="email" placeholder="your.email@example.com" required class="custom-input">
      </div>
      <div class="form-row">
        <label>Password</label>
        <input id="m_loginPassword" type="password" placeholder="Enter your password" required class="custom-input">
      </div>
      <div id="loginError" class="error-message"></div>
      <div style="margin-top:25px;">
        <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
      </div>
    </form>
    <p style="text-align:center; font-size:0.9rem; color:#64748b; margin-top:15px;">
        Need an account? 
        <a href="#" onclick="closeModal('loginModal'); openModal('signupModal'); return false;" style="color:#007BFF; font-weight:600;">
            Sign Up
        </a>
    </p>
  </div>
</div>


<!-- ‚≠ê UPDATED SELL ORDER MODAL matching the screenshot ‚≠ê -->
<div id="sellModal" class="modal" aria-hidden="true">
  <div class="modal-card card" style="max-width:450px;">
    <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom: 5px;">
      <div style="font-weight:700; font-size: 1.25rem;">Create order</div>
      <button onclick="closeModal('sellModal')" class="close-btn" aria-label="Close modal">√ó</button>
    </div>
    
    <form id="sellForm">
      <!-- Task Name Field -->
      <div class="form-row">
        <label style="font-weight: 600; margin-bottom: 4px; display: block;">Task Name</label>
        <input id="m_taskName" class="input-field" placeholder="Enter your Group Year " required>
      </div>

      <!-- Invite Link Type Radio Buttons -->
      <div class="form-row" style="margin-bottom: 20px;">
        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Invite Link Type</label>
        <div style="display:flex; gap: 25px;">
            <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                <input type="radio" name="inviteLinkType" value="Single" checked class="text-primary focus:ring-primary" style="accent-color: #6D28D9; border-color: #d1d5db; width: 18px; height: 18px; line-height: 1;">
                Single
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                <input type="radio" name="inviteLinkType" value="Folder" class="text-primary focus:ring-primary" style="accent-color: #6D28D9; border-color: #d1d5db; width: 18px; height: 18px; line-height: 1;">
                Folder
            </label>
        </div>
      </div>
      
      <!-- Group Link Textarea -->
      <div class="form-row">
        <label style="font-weight: 600; margin-bottom: 4px; display: block;">Group link</label>
        <textarea id="m_groupLinks" class="input-field" rows="4" placeholder="Enter group links, one per line." required></textarea>
      </div>
      
      <div id="sellError" class="error-message"></div>
      
      <!-- Buttons -->
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
        <button type="button" class="btn btn-outline" style="background: white; border-color: #d1d5db; color: #4b5563; font-weight:500;" onclick="closeModal('sellModal')">Cancel</button>
        <button type="submit" class="btn" style="background: #6D28D9; color: white; font-weight:600; border: 1px solid #6D28D9;">Submit</button>
      </div>
    </form>
  </div>
</div>
<!-- ‚≠ê END OF UPDATED SELL ORDER MODAL ‚≠ê -->


<!-- üí∞ UPDATED WITHDRAW MODAL matching the new design üí∞ -->
<div id="withdrawModal" class="modal" aria-hidden="true">
  <div class="modal-card card" style="max-width:340px; padding: 20px;">
    
    <!-- Modal Header -->
    <div style="display:flex;justify-content:space-between;align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
      <div style="font-weight:700; font-size: 1.2em;">Withdraw</div>
      <button onclick="closeModal('withdrawModal')" class="close-btn" aria-label="Close modal" style="font-size: 1.5em; color: #aaa;">√ó</button>
    </div>
    
    <form id="withdrawForm">
        <!-- Wallet Type Radio Group -->
        <div class="form-row">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #333; font-weight: 500;">
                Please import your withdraw
                <span style="color:red; margin-left: 2px;">*</span>
            </label>
            <div style="display: flex; gap: 20px; margin-top: 5px;">
                <!-- TRC20 Radio -->
                <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                    <input type="radio" id="trc20" name="wallet_type" value="TRC20" checked class="text-primary focus:ring-primary" style="accent-color: #4a4aed; border-color: #ccc; width: 16px; height: 16px;">
                    TRC20
                </label>
                <!-- Binance Radio -->
                <label style="display: flex; align-items: center; gap: 6px; font-weight: 400; cursor: pointer;">
                    <input type="radio" id="binance" name="wallet_type" value="Binance" class="text-primary focus:ring-primary" style="accent-color: #4a4aed; border-color: #ccc; width: 16px; height: 16px;">
                    Binance
                </label>
            </div>
        </div>

        <!-- Amount Input -->
        <div class="form-row">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #333; font-weight: 500;">
                Please enter the amount
                <span style="color:red; margin-left: 2px;">*</span>
            </label>
            <input id="m_withdrawAmount" class="input-field" type="number" placeholder="Please enter the amount" min="1" step="0.01" required>
        </div>
        
        <!-- Wallet Address Input -->
        <div class="form-row">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #333; font-weight: 500;">
                Wallet
                <span style="color:red; margin-left: 2px;">*</span>
            </label>
            <input id="m_withdrawAddress" class="input-field" type="text" placeholder="Please input your Wallet!" required>
        </div>

        <div id="withdrawError" class="error-message"></div>
        
        <!-- Buttons -->
        <div style="display:flex;justify-content:flex-end;gap:10px;padding-top:10px; margin-top: 10px;">
            <button type="button" class="btn" style="background-color: #f0f0f0; color: #333; font-weight: bold; padding: 10px 15px; border-radius: 5px;" onclick="closeModal('withdrawModal')">Cancel</button>
            <button type="submit" class="btn" style="background-color: #4a4aed; color: white; font-weight: bold; padding: 10px 15px; border-radius: 5px;">Confirm</button>
        </div>
    </form>
  </div>
</div>
<!-- üí∞ END OF UPDATED WITHDRAW MODAL üí∞ -->


<div id="recordsModal" class="modal" aria-hidden="true">
  <div class="modal-card card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Transaction Records</div>
      <button onclick="closeModal('recordsModal')" class="btn">‚úï</button>
    </div>
    <div style="margin-top:12px;">
      <div style="overflow:auto;">
        <table class="table">
          <thead><tr><th>Date</th><th>Type</th><th>Amount (USDT)</th></tr></thead>
          <tbody id="recordsBody"><tr><td colspan="3" style="padding:18px;text-align:center;color:#64748b;">No records yet</td></tr></tbody>
        </table>
      </div>
      <div style="text-align:right;margin-top:10px;"><button class="btn" onclick="closeModal('recordsModal')">Close</button></div>
    </div>
  </div>
</div>

<div id="contactModal" class="modal" aria-hidden="true">
  <div class="modal-card card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700;">Contact Support</div>
      <button onclick="closeModal('contactModal')" class="close-btn" aria-label="Close modal">√ó</button>
    </div>
    <form id="contactForm" style="margin-top:12px;">
      <label style="display: block; margin-bottom: 4px; font-weight: 600;">Name</label><input id="c_name" class="input-field" required>
      <label style="display: block; margin-top:8px; margin-bottom: 4px; font-weight: 600;">Email</label><input id="c_email" class="input-field" type="email" required>
      <label style="display: block; margin-top:8px; margin-bottom: 4px; font-weight: 600;">Message</label><textarea id="c_msg" class="input-field" rows="3" required></textarea>
      <div id="contactError" class="error-message"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button type="button" class="btn btn-outline" onclick="closeModal('contactModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚ùì How It Works Modal (NEW) -->
<div id="howItWorksModal" class="modal" aria-hidden="true">
  <div class="modal-card card" style="max-width:720px;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:700; font-size: 1.25rem;">How to Sell Your Telegram Group</div>
      <button onclick="closeModal('howItWorksModal')" class="close-btn" aria-label="Close modal">√ó</button>
    </div>
    
    <div style="margin-top:15px;">
      <!-- Content from the second file -->
      <img class="section-img"
           src="https://i.ibb.co/gFMBrkjZ/up-Grad-y-Clever-Tap-Domina-el-Marketing-Digital.jpg"
           alt="Instruction Image">

      <div class="section-text">
        <ol>
          <li>You must be the <strong>actual owner/creator</strong> of the Telegram group.</li>
          <li>The group must be a <strong>Private Group</strong>.</li>
          <li>‚ÄúChat History for New Members‚Äù must be <strong>enabled</strong>.</li>
          <li>The group's <strong>creation year</strong> must match our price list.</li>
          <li>Send the <strong>Invite Link</strong> of the group for verification.</li>
          <li>Transfer the group <strong>ownership</strong> to our agent.</li>
          <li>Our team will review and check the group's condition.</li>
          <li>If approved, you‚Äôll receive payment in <strong>USDT</strong>.</li>
        </ol>
      </div>
      
      <div style="text-align:right; margin-top:20px;">
        <button class="btn btn-primary" onclick="closeModal('howItWorksModal')">Understood</button>
      </div>
    </div>
  </div>
</div>
<!-- ‚ùì END OF How It Works Modal -->

<script>
// ===============================================
// üî• 2. FIREBASE CONFIG (USER PROVIDED - REAL KEYS)
// ===============================================
const firebaseConfig = {
    apiKey: "AIzaSyAdigwBY3np6j8RzwxYRlrMcBJG3wsiwaE", // <-- ‡§Ü‡§™‡§ï‡•Ä ‡§Ö‡§∏‡§≤‡•Ä API Key
    authDomain: "tg-grou---exchange-d85cb.firebaseapp.com",
    databaseURL: "https://tg-grou---exchange-d85cb-default-rtdb.firebaseio.com",
    projectId: "tg-grou---exchange-d85cb",
    storageBucket: "tg-grou---exchange-d85cb.firebasestorage.app",
    messagingSenderId: "578882291833",
    appId: "1:578882291833:web:4984927a8c0dc5fce16ca8",
    measurementId: "G-NFVF65KMVY"
};

if (firebase.apps.length === 0) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth(); 
const db = firebase.database();
let currentUserId = null; 
let currentBalance = 0; 
let currentTelegramUsername = 'Guest'; // Store username globally for use in contact form

/* App state & UI references */
const sidebar = document.getElementById('sidebar');
const appRoot = document.getElementById('appRoot');
const mobileOverlay = document.getElementById('mobileOverlay');
const collapseBtn = document.getElementById('collapseBtn');
const mobileOpenBtn = document.getElementById('mobileOpenBtn');
const contactBtn = document.getElementById('contactBtn');

/* UI Functions (Collapse, Modals) */
function setCollapsed(val){ 
    let collapsed = val; 
    if(collapsed) { 
        sidebar.classList.add('collapsed'); 
    } else { 
        sidebar.classList.remove('collapsed'); 
    } 
}
collapseBtn.addEventListener('click', () => { 
    // Toggle collapse only on desktop
    if(window.innerWidth > 1024) { 
        const isCollapsed = sidebar.classList.contains('collapsed');
        setCollapsed(!isCollapsed);
    } else {
        closeMobile(); 
    }
});

function closeMobile(){ sidebar.classList.remove('open'); mobileOverlay.classList.remove('show'); }
mobileOpenBtn.addEventListener('click', () => { sidebar.classList.add('open'); mobileOverlay.classList.add('show'); });
mobileOverlay.addEventListener('click', closeMobile);
contactBtn.addEventListener('click', () => openModal('contactModal'));
function openModal(id){ 
    const m = document.getElementById(id); 
    if(!m) return; 
    m.classList.add('open'); 
    m.setAttribute('aria-hidden','false'); 
    document.body.style.overflow = 'hidden'; 
    // Clear error message when opening modal
    const errorId = id.replace('Modal', 'Error');
    const errorEl = document.getElementById(errorId);
    if(errorEl) errorEl.textContent = '';
}
function closeModal(id){ 
    const m = document.getElementById(id); 
    if(!m) return; 
    m.classList.remove('open'); 
    m.setAttribute('aria-hidden','true'); 
    document.body.style.overflow = ''; 
}


// ===============================================
// üìà 3. REAL-TIME DATA HANDLING & DASHBOARD UPDATES
// ===============================================

// Listener for User Stats (Balance, Sold, Pending)
function setupStatsListener(userId) {
    const statsRef = db.ref(`users/${userId}/stats`);
    statsRef.on('value', (snapshot) => {
        const stats = snapshot.val() || { totalSold: 0, balance: 0.00, pending: 0, telegram: 'User' };
        
        document.getElementById('totalSold').textContent = stats.totalSold || 0;
        document.getElementById('balance').textContent = (stats.balance || 0).toFixed(2);
        document.getElementById('pending').textContent = stats.pending || 0;
        currentBalance = stats.balance || 0;
        
        // Display Telegram Username or Email prefix
        const username = stats.telegram || (auth.currentUser.email ? auth.currentUser.email.split('@')[0] : 'User');
        document.getElementById('userNameDisplay').textContent = username; // Update header display
        document.getElementById('welcomeMessage').textContent = `Welcome, ${username}!`;
        currentTelegramUsername = username; // Update global variable
    });
}

// MODIFIED: Listener for Task List (Orders) to display new columns
function setupOrdersListener(userId) {
    const ordersRef = db.ref(`users/${userId}/orders`).limitToLast(10);
    ordersRef.on('value', (snapshot) => {
        const orders = snapshot.val();
        const tbody = document.getElementById('taskBody');
        tbody.innerHTML = ''; 

        if (!orders) {
            // Updated colspan to 4 to match the new 4 columns
            tbody.innerHTML = '<tr><td colspan="4" style="padding:24px;text-align:center;color:#64748b;">No active orders found.</td></tr>';
            return;
        }

        Object.keys(orders).reverse().forEach(key => {
            const order = orders[key];
            const transferOwner = order.transferUsername || 'Pending...'; // NEW COLUMN: Transfer Group Owner
            const statusColor = order.status === 'Completed' ? '#28a745' : (order.status === 'Rejected' ? '#dc3545' : '#f97316');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${order.title}</td>
                <td>${order.amount}</td>
                <td>${transferOwner}</td>
                <td><span style="color:${statusColor};font-weight:600;">${order.status}</span></td>
            `;
            tbody.appendChild(tr);
        });
    });
}

// MODIFIED: Listener for Records (Transactions) to show status instead of +0.00
function setupRecordsListener(userId) {
    const recordsRef = db.ref(`users/${userId}/records`).limitToLast(20);
    recordsRef.on('value', (snapshot) => {
        const records = snapshot.val();
        const rb = document.getElementById('recordsBody');
        rb.innerHTML = ''; 

        if (!records) {
            rb.innerHTML = '<tr><td colspan="3" style="padding:18px;text-align:center;color:#64748b;">No records yet.</td></tr>';
            return;
        }

        Object.keys(records).reverse().forEach(key => {
            const record = records[key];
            const date = new Date(record.timestamp).toLocaleDateString();
            
            let amountDisplayContent;
            let statusColor;

            const amount = Number(record.amount);
            const isMonetary = amount !== 0; // Simplified check for monetary status

            if (isMonetary) {
                // Monetary Transaction
                const sign = amount > 0 ? '+' : '';
                amountDisplayContent = `${sign}${amount.toFixed(2)}`;
                statusColor = amount > 0 ? 'var(--success)' : 'var(--danger)';
            } else {
                // Non-monetary status record (Submission, Rejection with zero amount)
                amountDisplayContent = record.status;
                if(record.status === 'Completed') statusColor = 'var(--success)';
                else if(record.status === 'Rejected') statusColor = 'var(--danger)';
                else statusColor = '#f97316'; // Pending/Submitted
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${date}</td>
                <td>${record.type}</td>
                <td style="color:${statusColor};font-weight:600;">${amountDisplayContent}</td>
            `;
            rb.appendChild(tr);
        });
    });
}

// ============================
// üîê AUTHENTICATION HANDLERS
// ============================

function handleLoginState(user) {
    const userNameDisplay = document.getElementById('userNameDisplay');
    const authAction = document.getElementById('authAction');
    
    // Cleanup listeners on logout
    if (currentUserId) {
        db.ref(`users/${currentUserId}/stats`).off();
        db.ref(`users/${currentUserId}/orders`).off();
        db.ref(`users/${currentUserId}/records`).off();
    }

    if (user) {
        // Logged In: Show app, hide auth modals
        currentUserId = user.uid;
        appRoot.style.display = 'flex'; 
        closeModal('loginModal'); 
        closeModal('signupModal'); 
        
        // Update UI
        const username = user.email ? user.email.split('@')[0] : 'User'; 
        userNameDisplay.textContent = username;
        authAction.textContent = 'Logout';
        authAction.onclick = signOutUser;

        // Set up real-time data listeners
        setupStatsListener(user.uid);
        setupOrdersListener(user.uid);
        setupRecordsListener(user.uid);

    } else {
        // Logged Out: Hide app, show auth modal
        currentUserId = null;
        appRoot.style.display = 'none'; 
        document.getElementById('welcomeMessage').textContent = 'Welcome!';
        userNameDisplay.textContent = 'Guest';
        currentTelegramUsername = 'Guest';
        
        authAction.textContent = 'Login / Signup';
        authAction.onclick = () => openModal('loginModal');

        // Initial Flow: Open Signup modal if not logged in
        openModal('signupModal');
    }
}

function signUpUser() {
    const telegramUsername = document.getElementById('m_signupTelegram').value.trim();
    const email = document.getElementById('m_signupEmail').value.trim();
    const password = document.getElementById('m_signupPassword').value;
    const confirmPassword = document.getElementById('m_signupConfirmPassword').value;
    const errorEl = document.getElementById('signupError');
    errorEl.textContent = '';

    if (!telegramUsername || !email || !password || !confirmPassword) { errorEl.textContent = 'Please fill in all fields (‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç).'; return; }
    if (password.length < 6) { errorEl.textContent = 'Password must be at least 6 characters long.'; return; }
    if (password !== confirmPassword) { errorEl.textContent = 'Password and Confirm Password do not match.'; return; }

    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // After successful creation, the user is automatically logged in.
            // Save initial stats to Realtime Database
            db.ref(`users/${userCredential.user.uid}/stats`).set({
                telegram: telegramUsername, 
                totalSold: 0,
                balance: 0.00,
                pending: 0
            });
            
            document.getElementById('signupForm').reset();
            // handleLoginState will now run automatically and show the dashboard.
        })
        .catch((error) => {
            errorEl.textContent = 'Signup Failed: ' + error.message;
        });
}

function signInUser() {
    const email = document.getElementById('m_loginEmail').value;
    const password = document.getElementById('m_loginPassword').value;
    const errorEl = document.getElementById('loginError');
    errorEl.textContent = '';

    if (!email || !password) { errorEl.textContent = 'Please enter both email and password.'; return; }

    auth.signInWithEmailAndPassword(email, password)
        .then(() => {
            document.getElementById('loginForm').reset();
            // handleLoginState will take over and show the dashboard
        })
        .catch((error) => {
            errorEl.textContent = 'Login Failed: ' + error.message;
        });
}

function signOutUser() {
    auth.signOut()
        .then(() => {
            // Success, handleLoginState will run and show login modal
        })
        .catch((error) => {
            console.error('Logout Failed:', error.message);
        });
}


// ===============================================
// üí∞ 4. TRANSACTION HANDLERS (REAL WORKING)
// ===============================================

// MODIFIED: Create Sell Order - Record amount set to 0 and recordKey saved
function createSell(e){
    e.preventDefault();
    const errorEl = document.getElementById('sellError');
    errorEl.textContent = ''; 

    if(!currentUserId){ 
        errorEl.textContent = 'Please log in to create an order.';
        console.error('Error: User not logged in.'); 
        return; 
    }

    const taskName = document.getElementById('m_taskName').value.trim();
    const selectedLinkType = document.querySelector('input[name="inviteLinkType"]:checked');
    const inviteLinkType = selectedLinkType ? selectedLinkType.value : 'TRC20';
    const groupLinksText = document.getElementById('m_groupLinks').value.trim();
    
    if (!taskName || !groupLinksText) {
        errorEl.textContent = 'Task Name and Group links are required.';
        return;
    }

    const groupLinksArray = groupLinksText.split('\n').map(link => link.trim()).filter(link => link !== '');
    const amount = groupLinksArray.length; 
    
    if(amount === 0) {
        errorEl.textContent = 'Please enter at least one group link.';
        return;
    }

    // UPDATED: Using a fixed price per group for demonstration, based on the price list's highest value
    const pricePerGroup = 14.00; 
    const totalPrice = amount * pricePerGroup;
    const timestamp = firebase.database.ServerValue.TIMESTAMP;
    
    db.ref(`users/${currentUserId}/stats`).once('value').then(statsSnapshot => {
        const stats = statsSnapshot.val() || {};
        const telegramUsername = stats.telegram || (auth.currentUser.email ? auth.currentUser.email.split('@')[0] : 'User');
        
        const newOrderRef = db.ref(`users/${currentUserId}/orders`).push();
        const orderId = newOrderRef.key;
        
        // 1. Create initial record and get its key
        const recordRef = db.ref(`users/${currentUserId}/records`).push();
        const recordKey = recordRef.key;

        const userOrderData = {
            title: taskName, 
            amount: amount, 
            price: pricePerGroup, 
            totalPrice: totalPrice, 
            linkType: inviteLinkType, 
            links: groupLinksText, 
            status: 'Pending',
            transferUsername: null, 
            recordKey: recordKey, // <-- NEW: Store record key with order
            timestamp: timestamp
        };
        
        const adminOrderData = {
            orderId: orderId, 
            submittedByUid: currentUserId,
            submittedByUsername: telegramUsername,
            taskName: taskName,
            groupLinks: groupLinksText, 
            status: 'Pending', 
            recordKey: recordKey, // <-- NEW: Store record key for admin use
            timestamp: timestamp,
            totalPrice: totalPrice, 
            amount: amount,
        };

        // 2. Set Order in User's personal orders
        newOrderRef.set(userOrderData).then(() => {
            
            // 3. Set Order in Admin Queue
            db.ref(`admin_sell_orders_queue/${orderId}`).set(adminOrderData);

            // 4. Update Pending count in stats (Atomic Update for safety)
            const statsRef = db.ref(`users/${currentUserId}/stats`);
            statsRef.child('pending').transaction((currentPending) => {
                return (currentPending || 0) + 1;
            });
            
            // 5. Set the initial record (NO MONETARY AMOUNT)
            recordRef.set({
                type: 'Sell Order Submitted', 
                amount: 0, // Set amount to 0
                status: 'Pending',
                timestamp: timestamp
            });

            document.getElementById('sellForm').reset();
            closeModal('sellModal');
        }).catch(error => {
            errorEl.textContent = 'Failed to create order: ' + error.message;
            console.error('Failed to create order:', error.message);
        });
    }).catch(error => {
        errorEl.textContent = 'Failed to fetch user data: ' + error.message;
        console.error('Failed to fetch user data:', error.message);
    });
}

// MODIFIED: Submit Withdraw Request - Amount stored as negative to signify deduction
function submitWithdraw(e){
    e.preventDefault();
    const errorEl = document.getElementById('withdrawError');
    errorEl.textContent = ''; 

    if(!currentUserId){ 
        errorEl.textContent = 'Please log in to make a withdrawal.';
        console.error('Error: User not logged in.'); 
        return; 
    }

    const amount = parseFloat(document.getElementById('m_withdrawAmount').value);
    const address = document.getElementById('m_withdrawAddress').value.trim();
    
    // Read Wallet Type
    const selectedWalletType = document.querySelector('input[name="wallet_type"]:checked');
    const walletType = selectedWalletType ? selectedWalletType.value : 'TRC20';
    
    const timestamp = firebase.database.ServerValue.TIMESTAMP;
    
    if (amount <= 0 || isNaN(amount)) {
        errorEl.textContent = 'Please enter a valid amount.';
        return;
    }
    
    if (!address) {
        errorEl.textContent = 'Wallet address is required.';
        return;
    }

    if (amount > currentBalance) {
        // CHANGED: Removed Hindi from Insufficient Balance message
        errorEl.textContent = `Insufficient Balance. Available: ${currentBalance.toFixed(2)} USDT`;
        // CHANGED: Removed Hindi from console log
        console.error('Insufficient Balance. Current:', currentBalance);
        return;
    }

    const statsRef = db.ref(`users/${currentUserId}/stats`);
    // Atomically check balance and subtract amount
    statsRef.transaction((currentStats) => {
        if (currentStats && currentStats.balance >= amount) {
            
            // 1. Create Withdrawal Request
            db.ref(`users/${currentUserId}/withdrawals`).push().set({
                amount,
                address,
                walletType, 
                status: 'Pending', 
                timestamp: timestamp
            });
            
            // 2. Add Record
            db.ref(`users/${currentUserId}/records`).push().set({
                type: `Withdraw Request (${walletType})`, 
                amount: -amount, // Store as negative for display consistency (money out)
                status: 'Pending', 
                timestamp: timestamp
            });

            // 3. Update balance in stats
            currentStats.balance = (currentStats.balance || 0) - amount;
            return currentStats; // Commit transaction with new data
        } else if (currentStats) {
            console.error('Transaction failed: Insufficient funds after server check.');
            errorEl.textContent = 'Transaction failed. Please refresh and try again.';
            return; // Abort transaction
        }
        return currentStats;
    }).then(result => {
        if(result.committed) {
             document.getElementById('withdrawForm').reset();
             closeModal('withdrawModal');
        } else {
             // If transaction aborted, error is already shown in console/errorEl
        }
    }).catch(error => {
        errorEl.textContent = 'Withdrawal failed: ' + error.message;
        console.error('Withdrawal failed:', error.message);
    });
}


// NEW: Contact Support Form Submission Handler
function submitContactForm(e){
    e.preventDefault();
    const errorEl = document.getElementById('contactError');
    errorEl.textContent = '';

    const name = document.getElementById('c_name').value.trim();
    const email = document.getElementById('c_email').value.trim();
    const message = document.getElementById('c_msg').value.trim();

    if (!name || !email || !message) {
        errorEl.textContent = 'Please fill in all fields.';
        return;
    }

    if (!currentUserId) {
        errorEl.textContent = 'Please log in to submit a support request.';
        return;
    }

    const supportData = {
        name: name,
        email: email,
        message: message,
        userId: currentUserId,
        telegram: currentTelegramUsername,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        status: 'New'
    };

    db.ref('support_messages').push().set(supportData)
        .then(() => {
            errorEl.textContent = 'Message sent successfully! We will contact you soon.'; // Success message
            document.getElementById('contactForm').reset();
            setTimeout(() => closeModal('contactModal'), 2500); 
        })
        .catch(error => {
            errorEl.textContent = 'Failed to send message: ' + error.message;
            console.error('Failed to send support message:', error);
        });
}


// ============================
// üöÄ 5. INITIALIZATION
// ============================

document.addEventListener('DOMContentLoaded', () => {
    // Auth form handlers
    document.getElementById('signupForm').addEventListener('submit', (e) => { e.preventDefault(); signUpUser(); });
    document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); signInUser(); });
    
    // Transaction form handlers
    document.getElementById('sellForm').addEventListener('submit', createSell);
    document.getElementById('withdrawForm').addEventListener('submit', submitWithdraw);
    
    // Contact form handler (REAL SUBMISSION)
    document.getElementById('contactForm').addEventListener('submit', submitContactForm);

    // Auth state listener (starts the app logic)
    auth.onAuthStateChanged(handleLoginState);
});


/* Other UI/Accessibility (Unchanged) */
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){ closeModal('sellModal'); closeModal('withdrawModal'); closeModal('recordsModal'); closeModal('contactModal'); closeModal('signupModal'); closeModal('loginModal'); closeModal('howItWorksModal'); closeMobile(); }
});
function onResize(){
  if(window.innerWidth <= 768){ setCollapsed(false); closeMobile(); }
  else if(window.innerWidth > 768 && window.innerWidth <= 1024){ setCollapsed(true); } 
  else { setCollapsed(false); }
}
window.addEventListener('resize', onResize);
onResize();

</script>
</body>
</html>
